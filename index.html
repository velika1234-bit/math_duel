<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –î—É–µ–ª ‚ú® Gemini</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap');
        
        :root {
            --app-height: 100vh;
        }

        body {
            font-family: 'Comfortaa', cursive;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #f0f9ff;
            user-select: none;
            touch-action: none;
            height: var(--app-height);
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .active { display: flex; }

        .player-area {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around; 
            padding: 1vh 2vw;
            position: relative;
            min-height: 0; 
        }

        .player-1 { background-color: #dcfce7; transform: rotate(180deg); }
        .player-2 { background-color: #fee2e2; }

        .divider {
            height: 36px;
            width: 100%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .progress-container {
            width: 80%;
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        .progress-bar { height: 100%; transition: width 0.3s ease; }
        .progress-p1 { background: #22c55e; }
        .progress-p2 { background: #ef4444; }

        .input-numpad-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 0.5vh;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-display-box {
            width: 60px;
            height: 50px;
            background: white;
            border: 3px solid #cbd5e1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #334155;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .player-1 .input-display-box { color: #166534; border-color: #86efac; }
        .player-2 .input-display-box { color: #991b1b; border-color: #fca5a5; }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .num-btn {
            width: 40px;
            height: 36px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 3px 0 #cbd5e1;
            cursor: pointer;
        }

        .num-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #cbd5e1; }
        .num-btn.confirm { background: #22c55e; color: white; box-shadow: 0 3px 0 #16a34a; }
        .num-btn.clear { background: #f97316; color: white; box-shadow: 0 3px 0 #ea580c; }

        .player-info-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            width: 65px;
        }

        .avatar-emoji { 
            font-size: 2rem;
            line-height: 1;
            margin-bottom: 2px;
        }

        .player-name-label {
            font-size: 0.6rem;
            font-weight: bold;
            color: #475569;
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .level-badge {
            font-size: 0.55rem;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 20px;
            margin-top: 4px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .player-1 .player-name-label { color: #166534; }
        .player-2 .player-name-label { color: #991b1b; }

        .feedback {
            position: absolute;
            bottom: 110%; 
            left: 0;
            right: 0;
            font-weight: bold;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
            text-align: center;
            z-index: 20;
            white-space: nowrap;
        }

        .question-box {
            padding: 6px 12px;
            line-height: 1.25;
            width: 90%;
            max-height: 4.2rem; 
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.82rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            text-align: center;
        }

        .op-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }

        .op-btn.active-op {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body>

    <div id="screen-start" class="screen active bg-gradient-to-b from-blue-400 to-blue-600 text-white p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –î—É–µ–ª ‚ú®</h1>
        <div class="bg-white p-6 rounded-3xl shadow-2xl text-gray-800 w-full max-w-sm">
            <div class="mb-4">
                <label class="block font-bold mb-1 text-sm text-blue-600">–ò–≥—Ä–∞—á 1 (üê∂)</label>
                <input type="text" id="p1-name" value="–ò–≥—Ä–∞—á 1" class="w-full border-2 border-blue-100 rounded-xl p-3 text-sm focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label class="block font-bold mb-1 text-sm text-red-600">–ò–≥—Ä–∞—á 2 (üê±)</label>
                <div class="flex gap-2">
                    <input type="text" id="p2-name" value="–ò–≥—Ä–∞—á 2" class="flex-1 border-2 border-red-100 rounded-xl p-3 text-sm focus:outline-none focus:border-red-500">
                    <button onclick="toggleAI()" id="ai-toggle" class="bg-purple-500 text-white px-4 rounded-xl font-bold text-xs hover:bg-purple-600 transition-colors">ü§ñ –†–æ–±–æ—Ç</button>
                </div>
            </div>
            <button onclick="goToSettings()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-4 rounded-2xl text-xl shadow-lg transform active:scale-95 transition-all">–ù–ê–ü–†–ï–î</button>
            <button id="install-btn" class="hidden mt-4 w-full border-2 border-green-500 text-green-600 font-bold py-2 rounded-xl text-xs uppercase hover:bg-green-50 transition-colors">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</button>
        </div>
    </div>

    <div id="screen-settings" class="screen bg-blue-50 p-4">
        <h2 class="text-2xl font-bold mb-8 text-blue-800 text-center">–ò–∑–±–µ—Ä–∏ —Ç–∏–ø –∑–∞–¥–∞—á–∏</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <div id="card-simple" class="bg-white p-5 rounded-3xl shadow-md border-4 border-blue-400 cursor-pointer text-center" onclick="selectDifficulty('simple')">
                <div class="text-4xl">üî¢</div>
                <h3 class="text-sm font-bold mt-2">–î–µ–π—Å—Ç–≤–∏—è</h3>
            </div>
            <div id="card-hard" class="bg-white p-5 rounded-3xl shadow-md border-4 border-transparent cursor-pointer text-center" onclick="selectDifficulty('hard')">
                <div class="text-4xl">üìö</div>
                <h3 class="text-sm font-bold mt-2">–õ–æ–≥–∏–∫–∞</h3>
            </div>
        </div>
        
        <div class="grid grid-cols-4 gap-3 mt-8 w-full max-w-sm px-4">
            <button onclick="selectOp('+')" id="op-add" class="op-btn">+</button>
            <button onclick="selectOp('-')" id="op-sub" class="op-btn">-</button>
            <button onclick="selectOp('*')" id="op-mult" class="op-btn active-op">.</button>
            <button onclick="selectOp('/')" id="op-div" class="op-btn">√∑</button>
        </div>

        <button onclick="startGame()" class="mt-10 bg-green-500 text-white px-16 py-4 rounded-3xl text-xl font-bold shadow-lg hover:bg-green-600 transform active:scale-95 transition-all uppercase tracking-wide">–°–¢–ê–†–¢</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="player-area player-1" id="p1-area">
            <div class="bg-white question-box" id="p1-question">...</div>
            <div class="input-numpad-container">
                <div class="input-wrapper">
                    <div id="p1-feedback" class="feedback"></div>
                    <div class="input-display-box" id="p1-input-display"></div>
                </div>
                <div class="numpad">
                    <div class="num-btn" onclick="addNum(1, 1)">1</div><div class="num-btn" onclick="addNum(1, 2)">2</div><div class="num-btn" onclick="addNum(1, 3)">3</div>
                    <div class="num-btn" onclick="addNum(1, 4)">4</div><div class="num-btn" onclick="addNum(1, 5)">5</div><div class="num-btn" onclick="addNum(1, 6)">6</div>
                    <div class="num-btn" onclick="addNum(1, 7)">7</div><div class="num-btn" onclick="addNum(1, 8)">8</div><div class="num-btn" onclick="addNum(1, 9)">9</div>
                    <div class="num-btn clear" onclick="clearInput(1)">C</div><div class="num-btn" onclick="addNum(1, 0)">0</div><div class="num-btn confirm" onclick="checkAnswer(1)">‚úî</div>
                </div>
                <div class="player-info-column">
                    <div class="avatar-emoji">üê∂</div>
                    <div id="p1-name-display" class="player-name-label">–ò–≥—Ä–∞—á 1</div>
                    <div id="p1-level" class="level-badge">–ù–∏–≤–æ 1</div>
                </div>
            </div>
        </div>

        <div class="divider">
            <div class="progress-container">
                <div id="progress-p1" class="progress-bar progress-p1" style="width: 0%"></div>
                <div id="progress-p2" class="progress-bar progress-p2" style="width: 0%"></div>
            </div>
        </div>

        <div class="player-area player-2" id="p2-area">
            <div class="bg-white question-box" id="p2-question">...</div>
            <div class="input-numpad-container">
                <div class="input-wrapper">
                    <div id="p2-feedback" class="feedback"></div>
                    <div class="input-display-box" id="p2-input-display"></div>
                </div>
                <div class="numpad" id="p2-numpad">
                    <div class="num-btn" onclick="addNum(2, 1)">1</div><div class="num-btn" onclick="addNum(2, 2)">2</div><div class="num-btn" onclick="addNum(2, 3)">3</div>
                    <div class="num-btn" onclick="addNum(2, 4)">4</div><div class="num-btn" onclick="addNum(2, 5)">5</div><div class="num-btn" onclick="addNum(2, 6)">6</div>
                    <div class="num-btn" onclick="addNum(2, 7)">7</div><div class="num-btn" onclick="addNum(2, 8)">8</div><div class="num-btn" onclick="addNum(2, 9)">9</div>
                    <div class="num-btn clear" onclick="clearInput(2)">C</div><div class="num-btn" onclick="addNum(2, 0)">0</div><div class="num-btn confirm" onclick="checkAnswer(2)">‚úî</div>
                </div>
                <div class="player-info-column">
                    <div class="avatar-emoji">üê±</div>
                    <div id="p2-name-display" class="player-name-label">–ò–≥—Ä–∞—á 2</div>
                    <div id="p2-level" class="level-badge">–ù–∏–≤–æ 1</div>
                </div>
            </div>
            <div id="p2-ai-msg" class="hidden text-red-500 font-bold italic animate-pulse text-[10px] mt-1">–†–æ–±–æ—Ç—ä—Ç –ø—Ä–µ—Å–º—è—Ç–∞...</div>
        </div>
    </div>

    <div id="screen-result" class="screen bg-purple-700 text-white p-6 relative">
        <canvas id="fireworks-canvas" class="absolute inset-0 pointer-events-none"></canvas>
        <div class="z-10 text-center">
            <h2 class="text-3xl font-bold mb-2">–ü–û–ë–ï–î–ò–¢–ï–õ!</h2>
            <div id="winner-name" class="text-5xl font-black text-yellow-300 mb-10 uppercase tracking-tighter">–ò–ú–ï</div>
            <button onclick="resetGame()" class="bg-white text-purple-700 px-12 py-4 rounded-2xl text-xl font-bold shadow-xl">–ù–û–í–ê –ò–ì–†–ê</button>
        </div>
    </div>

    <script>
        let players = {
            1: { name: '–ò–≥—Ä–∞—á 1', score: 0, input: '', currentAns: 0, level: 1, lastStartTime: 0 },
            2: { name: '–ò–≥—Ä–∞—á 2', score: 0, input: '', currentAns: 0, level: 1, lastStartTime: 0, isAI: false }
        };
        let gameSettings = { difficulty: 'simple', op: '*' };
        const WIN_SCORE = 10;
        let gameActive = false;

        const names = ["–ú–∏–ª–∞", "–ù–∏–∫–∏", "–ê–Ω–∏", "–í–∏–∫—Ç–æ—Ä", "–¢–µ–æ", "–ï–ª–∏", "–ú–∞—Ä—Ç–∏"];
        const objects = ["—è–±—ä–ª–∫–∏", "–∫–æ–ª–∏—á–∫–∏", "–º–æ–ª–∏–≤–∏", "—Ç–æ–ø–∫–∏", "—Å—Ç–∏–∫–µ—Ä–∏", "–±–æ–Ω–±–æ–Ω–∏", "–∫—Ä—É—à–∏"];
        
        const problemTemplates = {
            "+": [
                "${name} –∏–º–∞—à–µ ${a} ${item}. –ü–æ–ª—É—á–∏ –æ—â–µ ${b} –æ—Ç –ø—Ä–∏—è—Ç–µ–ª. –ö–æ–ª–∫–æ –∏–º–∞ —Å–µ–≥–∞?",
                "–í –µ–¥–Ω–∞ –∫—É—Ç–∏—è –∏–º–∞ ${a} ${item}, –∞ –≤ –¥—Ä—É–≥–∞ - ${b}. –ö–æ–ª–∫–æ —Å–∞ –æ–±—â–æ?",
                "${name} –Ω–∞–º–µ—Ä–∏ ${a} ${item} —Å—É—Ç—Ä–∏–Ω—Ç–∞ –∏ ${b} —Å–ª–µ–¥–æ–±–µ–¥. –ö–æ–ª–∫–æ ${item} –Ω–∞–º–µ—Ä–∏ –æ–±—â–æ?",
                "–ù–∞ –º–∞—Å–∞—Ç–∞ –∏–º–∞ ${a} —á–µ—Ä–≤–µ–Ω–∏ ${item} –∏ ${b} –∑–µ–ª–µ–Ω–∏. –ö–æ–ª–∫–æ —Å–∞ –≤—Å–∏—á–∫–æ?"
            ],
            "-": [
                "${name} –∏–º–∞—à–µ ${total} ${item}. –î–∞–¥–µ ${b} –Ω–∞ —Å–µ—Å—Ç—Ä–∞ —Å–∏. –ö–æ–ª–∫–æ –º—É –æ—Å—Ç–∞–Ω–∞—Ö–∞?",
                "–í –∫–æ—à–Ω–∏—Ü–∞ –∏–º–∞—à–µ ${total} ${item}. –ò–∑–≤–∞–¥–∏—Ö–∞ ${b} –æ—Ç —Ç—è—Ö. –ö–æ–ª–∫–æ –æ—Å—Ç–∞–Ω–∞—Ö–∞?",
                "${name} —Ç—Ä—è–±–≤–∞—à–µ –¥–∞ —Ä–µ—à–∏ ${total} –∑–∞–¥–∞—á–∏, –Ω–æ —Ä–µ—à–∏ —Å–∞–º–æ ${b}. –ö–æ–ª–∫–æ –º—É –æ—Å—Ç–∞–≤–∞—Ç?",
                "–ò–º–∞—Ö ${total} ${item}, –Ω–æ –∑–∞–≥—É–±–∏—Ö ${b}. –ö–æ–ª–∫–æ ${item} –∏–º–∞–º —Å–µ–≥–∞?"
            ],
            "*": [
                "${name} –∏–º–∞ ${a} –∫—É—Ç–∏–∏. –í—ä–≤ –≤—Å—è–∫–∞ –∫—É—Ç–∏—è –∏–º–∞ –ø–æ ${b} ${item}. –ö–æ–ª–∫–æ —Å–∞ –æ–±—â–æ?",
                "${name} –∫—É–ø–∏ ${a} –ø–∞–∫–µ—Ç–∞ ${item}. –í—ä–≤ –≤—Å–µ–∫–∏ –∏–º–∞ ${b} –±—Ä–æ—è. –ö–æ–ª–∫–æ ${item} –∏–º–∞?",
                "–ù–∞ ${a} –ø—Ä–∏—è—Ç–µ–ª–∏ –¥–∞–¥–æ—Ö –ø–æ ${b} ${item}. –ö–æ–ª–∫–æ ${item} —Ä–∞–∑–¥–∞–¥–æ—Ö –æ–±—â–æ?",
                "${name} –Ω–∞—Ä–µ–¥–∏ ${a} —Ä–µ–¥–∞ —Å –ø–æ ${b} ${item} –Ω–∞ —Ä–µ–¥. –ö–æ–ª–∫–æ —Å–∞ –≤—Å–∏—á–∫–æ?"
            ],
            "/": [
                "${name} –∏–º–∞ ${total} ${item} –∏ –≥–∏ —Ä–∞–∑–¥–µ–ª–∏ –Ω–∞ ${a} –¥–µ—Ü–∞. –ü–æ –∫–æ–ª–∫–æ –∏–º–∞ –∑–∞ –≤—Å—è–∫–æ?",
                "${name} —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–∏ ${total} ${item} –≤ ${a} –∫—É—Ç–∏–∏. –ü–æ –∫–æ–ª–∫–æ —Å–∞ –≤ –∫—É—Ç–∏—è?",
                "–ò–º–∞–º–µ ${total} ${item}. –ê–∫–æ —Å–ª–æ–∂–∏–º –ø–æ ${b} –≤ –ø–∞–∫–µ—Ç, –∫–æ–ª–∫–æ –ø–∞–∫–µ—Ç–∞ –Ω–∏ —Ç—Ä—è–±–≤–∞—Ç?",
                "–†–∞–∑–¥–µ–ª–∏ ${total} ${item} –Ω–∞ ${a} —Ä–∞–≤–Ω–∏ –≥—Ä—É–ø–∏. –ö–æ–ª–∫–æ –∏–º–∞ –≤—ä–≤ –≤—Å—è–∫–∞ –≥—Ä—É–ø–∞?"
            ]
        };

        function updateAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', updateAppHeight);
        updateAppHeight();

        function goToSettings() {
            players[1].name = document.getElementById('p1-name').value || '–ò–≥—Ä–∞—á 1';
            players[2].name = document.getElementById('p2-name').value || '–ò–≥—Ä–∞—á 2';
            document.getElementById('p1-name-display').innerText = players[1].name;
            document.getElementById('p2-name-display').innerText = players[2].name;
            switchScreen('screen-settings');
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-game') updateAppHeight();
        }

        function toggleAI() {
            players[2].isAI = !players[2].isAI;
            document.getElementById('ai-toggle').innerText = players[2].isAI ? "ü§ñ –†–æ–±–æ—Ç" : "üë¶ –ß–æ–≤–µ–∫";
            document.getElementById('p2-name').value = players[2].isAI ? "–†–æ–±–æ—Ç –ú–∞–∫—Å" : "–ò–≥—Ä–∞—á 2";
        }

        function selectDifficulty(d) {
            gameSettings.difficulty = d;
            document.getElementById('card-simple').style.borderColor = (d === 'simple') ? '#3b82f6' : 'transparent';
            document.getElementById('card-hard').style.borderColor = (d === 'hard') ? '#a855f7' : 'transparent';
        }

        function selectOp(op) {
            gameSettings.op = op;
            const ids = { '+': 'op-add', '-': 'op-sub', '*': 'op-mult', '/': 'op-div' };
            document.querySelectorAll('.op-btn').forEach(btn => btn.classList.remove('active-op'));
            document.getElementById(ids[op]).classList.add('active-op');
        }

        function startGame() {
            players[1].score = 0; players[2].score = 0;
            players[1].level = 1; players[2].level = 1;
            updateUILevels();
            updateProgress();
            if (players[2].isAI) {
                document.getElementById('p2-numpad').classList.add('hidden');
                document.getElementById('p2-ai-msg').classList.remove('hidden');
            } else {
                document.getElementById('p2-numpad').classList.remove('hidden');
                document.getElementById('p2-ai-msg').classList.add('hidden');
            }
            generateProblem(1); generateProblem(2);
            switchScreen('screen-game');
            gameActive = true;
            if (players[2].isAI) triggerAI();
        }

        function updateUILevels() {
            document.getElementById('p1-level').innerText = `–ù–∏–≤–æ ${players[1].level}`;
            document.getElementById('p2-level').innerText = `–ù–∏–≤–æ ${players[2].level}`;
        }

        function generateProblem(pId) {
            const qEl = document.getElementById(`p${pId}-question`);
            players[pId].input = '';
            document.getElementById(`p${pId}-input-display`).innerText = '';

            let q, ans;
            const lvl = players[pId].level;
            const op = gameSettings.op;
            
            let a, b;
            if (op === '+' || op === '-') {
                a = Math.floor(Math.random() * (5 + lvl * 5)) + 2;
                b = Math.floor(Math.random() * (5 + lvl * 5)) + 2;
            } else {
                a = Math.floor(Math.random() * (2 + lvl)) + 2;
                b = Math.floor(Math.random() * (2 + lvl)) + 2;
            }

            if (gameSettings.difficulty === 'simple') {
                switch(op) {
                    case '+': q = `${a} + ${b} = ?`; ans = a + b; break;
                    case '-': if(a < b) [a, b] = [b, a]; q = `${a} - ${b} = ?`; ans = a - b; break;
                    case '*': q = `${a} . ${b} = ?`; ans = a * b; break;
                    case '/': q = `${a*b} √∑ ${a} = ?`; ans = b; break;
                }
            } else {
                const templates = problemTemplates[op];
                const template = templates[Math.floor(Math.random() * templates.length)];
                const name = names[Math.floor(Math.random() * names.length)];
                const item = objects[Math.floor(Math.random() * objects.length)];
                
                switch(op) {
                    case '+': ans = a + b; q = template.replace("${name}", name).replace("${a}", a).replace("${b}", b).replace(/\${item}/g, item); break;
                    case '-': if(a < b) [a, b] = [b, a]; ans = a - b; q = template.replace("${name}", name).replace("${total}", a).replace("${b}", b).replace(/\${item}/g, item); break;
                    case '*': ans = a * b; q = template.replace("${name}", name).replace("${a}", a).replace("${b}", b).replace(/\${item}/g, item); break;
                    case '/': ans = b; q = template.replace("${name}", name).replace("${total}", a*b).replace("${a}", a).replace("${b}", b).replace(/\${item}/g, item); break;
                }
            }
            players[pId].currentAns = ans;
            players[pId].lastStartTime = Date.now();
            qEl.innerText = q;
        }

        function addNum(pId, n) { 
            if (gameActive && players[pId].input.length < 5) { 
                players[pId].input += n; 
                document.getElementById(`p${pId}-input-display`).innerText = players[pId].input; 
            } 
        }

        function clearInput(pId) { 
            players[pId].input = ''; 
            document.getElementById(`p${pId}-input-display`).innerText = ''; 
        }

        function checkAnswer(pId) {
            if (!gameActive || players[pId].input === '') return;
            const val = parseInt(players[pId].input);
            const timeTaken = (Date.now() - players[pId].lastStartTime) / 1000;
            clearInput(pId);

            if (val === players[pId].currentAns) {
                players[pId].score++; 
                if (timeTaken < 5) {
                    players[pId].level++;
                    showFeedback(pId, "–ë–™–†–ó–û –ò –í–Ø–†–ù–û! üöÄ", "#3b82f6");
                } else {
                    showFeedback(pId, "–í–Ø–†–ù–û! ‚ú®", "#16a34a");
                }
                updateUILevels();
                updateProgress();
                if (players[pId].score >= WIN_SCORE) return endGame(players[pId].name);
                generateProblem(pId);
            } else {
                players[pId].level = Math.max(1, players[pId].level - 1);
                updateUILevels();
                showFeedback(pId, `–ì–†–ï–®–ù–û! (${players[pId].currentAns})`, "#dc2626");
                generateProblem(pId);
            }
        }

        function showFeedback(pId, txt, col) {
            const el = document.getElementById(`p${pId}-feedback`);
            el.innerText = txt; el.style.color = col; el.style.opacity = 1;
            el.style.transform = "translateY(-10px)";
            setTimeout(() => {
                el.style.opacity = 0;
                el.style.transform = "translateY(0)";
            }, 1200);
        }

        function updateProgress() {
            document.getElementById('progress-p1').style.width = (players[1].score/WIN_SCORE)*50 + '%';
            document.getElementById('progress-p2').style.width = (players[2].score/WIN_SCORE)*50 + '%';
        }

        function triggerAI() {
            if (!gameActive || !players[2].isAI) return;
            setTimeout(() => {
                if (!gameActive) return;
                players[2].input = players[2].currentAns.toString();
                checkAnswer(2);
                if (gameActive) triggerAI();
            }, 5000 + Math.random()*5000);
        }

        function endGame(w) {
            gameActive = false; document.getElementById('winner-name').innerText = w;
            switchScreen('screen-result'); startFireworks();
        }

        function resetGame() { switchScreen('screen-start'); }

        const can = document.getElementById('fireworks-canvas');
        const ctx = can.getContext('2d');
        let pts = [];
        function startFireworks() { can.width = window.innerWidth; can.height = window.innerHeight; pts = []; ani(); }
        function ani() {
            if (!document.getElementById('screen-result').classList.contains('active')) return;
            ctx.clearRect(0,0,can.width,can.height);
            if (Math.random()<0.1) {
                const x=Math.random()*can.width, y=Math.random()*can.height, c=`hsl(${Math.random()*360},100%,50%)`;
                for(let i=0; i<12; i++) pts.push({x,y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,c,a:1});
            }
            pts.forEach((p,i) => {
                p.x+=p.vx; p.y+=p.vy; p.a-=0.02; ctx.globalAlpha=p.a; ctx.fillStyle=p.c;
                ctx.beginPath(); ctx.arc(p.x,p.y,2,0,7); ctx.fill();
                if(p.a<=0) pts.splice(i,1);
            });
            requestAnimationFrame(ani);
        }
    </script>
</body>
</html>

