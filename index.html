<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –î—É–µ–ª ‚ú® Gemini</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap');
        
        :root {
            --app-height: 100vh;
        }

        body {
            font-family: 'Comfortaa', cursive;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #f0f9ff;
            user-select: none;
            touch-action: none;
            height: var(--app-height);
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .active { display: flex; }

        /* Player containers */
        .player-area {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around; 
            padding: 1vh 2vw;
            position: relative;
            min-height: 0; 
        }

        .player-1 { background-color: #dcfce7; transform: rotate(180deg); }
        .player-2 { background-color: #fee2e2; }

        .divider {
            height: 36px;
            width: 100%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .progress-container {
            width: 80%;
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        .progress-bar { height: 100%; transition: width 0.3s ease; }
        .progress-p1 { background: #22c55e; }
        .progress-p2 { background: #ef4444; }

        /* Compact Layout: Input | Numpad | Player Info */
        .input-numpad-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Brought closer together */
            width: 100%;
            margin-bottom: 0.5vh;
        }

        /* Container for Input + Feedback on top */
        .input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-display-box {
            width: 60px;
            height: 50px;
            background: white;
            border: 3px solid #cbd5e1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #334155;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .player-1 .input-display-box { color: #166534; border-color: #86efac; }
        .player-2 .input-display-box { color: #991b1b; border-color: #fca5a5; }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .num-btn {
            width: 40px;
            height: 36px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 3px 0 #cbd5e1;
            cursor: pointer;
        }

        .num-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #cbd5e1; }
        .num-btn.confirm { background: #22c55e; color: white; box-shadow: 0 3px 0 #16a34a; }
        .num-btn.clear { background: #f97316; color: white; box-shadow: 0 3px 0 #ea580c; }

        /* Player Info Section */
        .player-info-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            width: 65px;
        }

        .avatar-emoji { 
            font-size: 2rem;
            line-height: 1;
            margin-bottom: 2px;
        }

        .player-name-label {
            font-size: 0.6rem;
            font-weight: bold;
            color: #475569;
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-1 .player-name-label { color: #166534; }
        .player-2 .player-name-label { color: #991b1b; }

        .feedback {
            position: absolute;
            bottom: 110%; 
            left: 0;
            right: 0;
            font-weight: bold;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
            text-align: center;
            z-index: 20;
            white-space: nowrap;
        }

        /* Question Box Constraint */
        .question-box {
            padding: 6px 10px;
            line-height: 1.2;
            width: 90%;
            max-height: 3.5rem; 
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body>

    <!-- Screen 1: Login -->
    <div id="screen-start" class="screen active bg-gradient-to-b from-blue-400 to-blue-600 text-white p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –î—É–µ–ª ‚ú®</h1>
        <div class="bg-white p-6 rounded-3xl shadow-2xl text-gray-800 w-full max-w-sm">
            <div class="mb-4">
                <label class="block font-bold mb-1 text-sm text-blue-600">–ò–≥—Ä–∞—á 1 (üê∂)</label>
                <input type="text" id="p1-name" value="–ò–≥—Ä–∞—á 1" class="w-full border-2 border-blue-100 rounded-xl p-3 text-sm focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label class="block font-bold mb-1 text-sm text-red-600">–ò–≥—Ä–∞—á 2 (üê±)</label>
                <div class="flex gap-2">
                    <input type="text" id="p2-name" value="–ò–≥—Ä–∞—á 2" class="flex-1 border-2 border-red-100 rounded-xl p-3 text-sm focus:outline-none focus:border-red-500">
                    <button onclick="toggleAI()" id="ai-toggle" class="bg-purple-500 text-white px-4 rounded-xl font-bold text-xs hover:bg-purple-600 transition-colors">ü§ñ –†–æ–±–æ—Ç</button>
                </div>
            </div>
            <button onclick="goToSettings()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-4 rounded-2xl text-xl shadow-lg transform active:scale-95 transition-all">–ù–ê–ü–†–ï–î</button>
            <button id="install-btn" class="hidden mt-4 w-full border-2 border-purple-500 text-purple-600 font-bold py-2 rounded-xl text-xs uppercase hover:bg-purple-50 transition-colors">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</button>
        </div>
    </div>

    <!-- Screen 2: Settings -->
    <div id="screen-settings" class="screen bg-blue-50 p-4">
        <h2 class="text-2xl font-bold mb-8 text-blue-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <div id="card-simple" class="bg-white p-5 rounded-3xl shadow-md border-4 border-blue-400 cursor-pointer text-center" onclick="selectDifficulty('simple')">
                <div class="text-4xl">üî¢</div>
                <h3 class="text-sm font-bold mt-2">–¢–∞–±–ª–∏—Ü–∞</h3>
            </div>
            <div id="card-hard" class="bg-white p-5 rounded-3xl shadow-md border-4 border-transparent cursor-pointer text-center" onclick="selectDifficulty('hard')">
                <div class="text-4xl">‚ú®</div>
                <h3 class="text-sm font-bold mt-2">–ò–ò –ó–∞–¥–∞—á–∏</h3>
            </div>
        </div>
        <div class="flex gap-6 mt-8">
            <button onclick="selectOp('*')" id="op-mult" class="op-btn bg-blue-400 text-white px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold transition-all text-xl">.</button>
            <button onclick="selectOp('/')" id="op-div" class="op-btn bg-white text-blue-600 px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold transition-all text-xl">√∑</button>
        </div>
        <button onclick="startGame()" class="mt-10 bg-green-500 text-white px-16 py-4 rounded-3xl text-xl font-bold shadow-lg hover:bg-green-600 transform active:scale-95 transition-all uppercase tracking-wide">–°–¢–ê–†–¢</button>
    </div>

    <!-- Screen 3: Game -->
    <div id="screen-game" class="screen">
        <!-- PLAYER 1 (Top, Rotated) -->
        <div class="player-area player-1" id="p1-area">
            <div class="bg-white question-box" id="p1-question">...</div>
            <div class="input-numpad-container">
                <div class="input-wrapper">
                    <div id="p1-feedback" class="feedback"></div>
                    <div class="input-display-box" id="p1-input-display"></div>
                </div>
                <div class="numpad">
                    <div class="num-btn" onclick="addNum(1, 1)">1</div><div class="num-btn" onclick="addNum(1, 2)">2</div><div class="num-btn" onclick="addNum(1, 3)">3</div>
                    <div class="num-btn" onclick="addNum(1, 4)">4</div><div class="num-btn" onclick="addNum(1, 5)">5</div><div class="num-btn" onclick="addNum(1, 6)">6</div>
                    <div class="num-btn" onclick="addNum(1, 7)">7</div><div class="num-btn" onclick="addNum(1, 8)">8</div><div class="num-btn" onclick="addNum(1, 9)">9</div>
                    <div class="num-btn clear" onclick="clearInput(1)">C</div><div class="num-btn" onclick="addNum(1, 0)">0</div><div class="num-btn confirm" onclick="checkAnswer(1)">‚úî</div>
                </div>
                <div class="player-info-column">
                    <div class="avatar-emoji">üê∂</div>
                    <div id="p1-name-display" class="player-name-label">–ò–≥—Ä–∞—á 1</div>
                </div>
            </div>
        </div>

        <div class="divider">
            <div class="progress-container">
                <div id="progress-p1" class="progress-bar progress-p1" style="width: 0%"></div>
                <div id="progress-p2" class="progress-bar progress-p2" style="width: 0%"></div>
            </div>
        </div>

        <!-- PLAYER 2 (Bottom) -->
        <div class="player-area player-2" id="p2-area">
            <div class="bg-white question-box" id="p2-question">...</div>
            <div class="input-numpad-container">
                <div class="input-wrapper">
                    <div id="p2-feedback" class="feedback"></div>
                    <div class="input-display-box" id="p2-input-display"></div>
                </div>
                <div class="numpad" id="p2-numpad">
                    <div class="num-btn" onclick="addNum(2, 1)">1</div><div class="num-btn" onclick="addNum(2, 2)">2</div><div class="num-btn" onclick="addNum(2, 3)">3</div>
                    <div class="num-btn" onclick="addNum(2, 4)">4</div><div class="num-btn" onclick="addNum(2, 5)">5</div><div class="num-btn" onclick="addNum(2, 6)">6</div>
                    <div class="num-btn" onclick="addNum(2, 7)">7</div><div class="num-btn" onclick="addNum(2, 8)">8</div><div class="num-btn" onclick="addNum(2, 9)">9</div>
                    <div class="num-btn clear" onclick="clearInput(2)">C</div><div class="num-btn" onclick="addNum(2, 0)">0</div><div class="num-btn confirm" onclick="checkAnswer(2)">‚úî</div>
                </div>
                <div class="player-info-column">
                    <div class="avatar-emoji">üê±</div>
                    <div id="p2-name-display" class="player-name-label">–ò–≥—Ä–∞—á 2</div>
                </div>
            </div>
            <div id="p2-ai-msg" class="hidden text-red-500 font-bold italic animate-pulse text-[10px] mt-1">–ö–æ–º–ø—é—Ç—ä—Ä—ä—Ç –º–∏—Å–ª–∏...</div>
        </div>
    </div>

    <!-- Screen Result -->
    <div id="screen-result" class="screen bg-purple-700 text-white p-6 relative">
        <canvas id="fireworks-canvas" class="absolute inset-0 pointer-events-none"></canvas>
        <div class="z-10 text-center">
            <h2 class="text-3xl font-bold mb-2">–ü–û–ë–ï–î–ò–¢–ï–õ!</h2>
            <div id="winner-name" class="text-5xl font-black text-yellow-300 mb-10 uppercase tracking-tighter">–ò–ú–ï</div>
            <button onclick="resetGame()" class="bg-white text-purple-700 px-12 py-4 rounded-2xl text-xl font-bold shadow-xl">–ù–û–í–ê –ò–ì–†–ê</button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyBRSiitoPDvEBMUnKb63AteGrkkUUKA1q4"; 

        let players = {
            1: { name: '–ò–≥—Ä–∞—á 1', score: 0, input: '', currentAns: 0 },
            2: { name: '–ò–≥—Ä–∞—á 2', score: 0, input: '', currentAns: 0, isAI: false }
        };
        let gameSettings = { difficulty: 'simple', op: '*' };
        const WIN_SCORE = 10;
        let gameActive = false;

        function updateAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', updateAppHeight);
        updateAppHeight();

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            } catch (error) {
                if (retries === 0) throw error;
                await new Promise(resolve => setTimeout(resolve, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        }

        async function callGemini(prompt, sys = "–¢–∏ —Å–∏ —É—á–∏—Ç–µ–ª –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞. –û—Ç–≥–æ–≤–∞—Ä—è–π –≤–∏–Ω–∞–≥–∏ —Å JSON.") {
            if (!apiKey) return null;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: sys }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return content ? JSON.parse(content) : null;
            } catch (e) { return null; }
        }

        function goToSettings() {
            players[1].name = document.getElementById('p1-name').value || '–ò–≥—Ä–∞—á 1';
            players[2].name = document.getElementById('p2-name').value || '–ò–≥—Ä–∞—á 2';
            document.getElementById('p1-name-display').innerText = players[1].name;
            document.getElementById('p2-name-display').innerText = players[2].name;
            switchScreen('screen-settings');
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-game') updateAppHeight();
        }

        function toggleAI() {
            players[2].isAI = !players[2].isAI;
            document.getElementById('ai-toggle').innerText = players[2].isAI ? "ü§ñ –†–æ–±–æ—Ç" : "üë¶ –ß–æ–≤–µ–∫";
            document.getElementById('p2-name').value = players[2].isAI ? "–†–æ–±–æ—Ç –ú–∞–∫—Å" : "–ò–≥—Ä–∞—á 2";
        }

        function selectDifficulty(d) {
            gameSettings.difficulty = d;
            document.getElementById('card-simple').style.borderColor = (d === 'simple') ? '#3b82f6' : 'transparent';
            document.getElementById('card-hard').style.borderColor = (d === 'hard') ? '#a855f7' : 'transparent';
        }

        function selectOp(op) {
            gameSettings.op = op;
            const multBtn = document.getElementById('op-mult');
            const divBtn = document.getElementById('op-div');
            if (op === '*') {
                multBtn.className = 'op-btn bg-blue-400 text-white px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
                divBtn.className = 'op-btn bg-white text-blue-600 px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
            } else {
                multBtn.className = 'op-btn bg-white text-blue-600 px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
                divBtn.className = 'op-btn bg-blue-400 text-white px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
            }
        }

        function startGame() {
            players[1].score = 0; players[2].score = 0;
            updateProgress();
            if (players[2].isAI) {
                document.getElementById('p2-numpad').classList.add('hidden');
                document.getElementById('p2-ai-msg').classList.remove('hidden');
            } else {
                document.getElementById('p2-numpad').classList.remove('hidden');
                document.getElementById('p2-ai-msg').classList.add('hidden');
            }
            generateProblem(1); generateProblem(2);
            switchScreen('screen-game');
            gameActive = true;
            if (players[2].isAI) triggerAI();
        }

        async function generateProblem(pId) {
            const qEl = document.getElementById(`p${pId}-question`);
            qEl.innerHTML = '<span class="loading-dots">–ú–∏—Å–ª–∏</span>';
            players[pId].input = '';
            document.getElementById(`p${pId}-input-display`).innerText = '';

            let q, ans;
            if (gameSettings.difficulty === 'simple') {
                let a = Math.floor(Math.random()*8)+2;
                let b = Math.floor(Math.random()*8)+2;
                if (gameSettings.op === '*') { q = `${a} . ${b} = ?`; ans = a*b; }
                else { q = `${a*b} √∑ ${a} = ?`; ans = b; }
            } else {
                const prompt = `–ù–∞–ø–∏—à–∏ 1 –ú–ù–û–ì–û –ö–†–ê–¢–ö–ê —Ç–µ–∫—Å—Ç–æ–≤–∞ –∑–∞–¥–∞—á–∞ (–ú–ê–ö–° 50 –ó–ù–ê–ö–ê) –∑–∞ ${gameSettings.op === '*' ? '—É–º–Ω–æ–∂–µ–Ω–∏–µ' : '–¥–µ–ª–µ–Ω–∏–µ'} –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏. JSON: {"question": "...", "answer": —á–∏—Å–ª–æ}`;
                const res = await callGemini(prompt, "–¢–∏ —Å–∏ —É—á–∏—Ç–µ–ª. –ü–∏—à–∏ –∑–∞–¥–∞—á–∏ –¥–æ 2 —Ä–µ–¥–∞. –ò–∑–ø–æ–ª–∑–≤–∞–π '.' –∑–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ.");
                if (res) { q = res.question; ans = res.answer; } 
                else { q = "–ì—Ä–µ—à–∫–∞! –ü—Ä–æ–≤–µ—Ä–∏ –º—Ä–µ–∂–∞—Ç–∞."; ans = 0; }
            }
            players[pId].currentAns = ans;
            qEl.innerText = q;
        }

        function addNum(pId, n) { 
            if (gameActive && players[pId].input.length < 5) { 
                players[pId].input += n; 
                document.getElementById(`p${pId}-input-display`).innerText = players[pId].input; 
            } 
        }

        function clearInput(pId) { 
            players[pId].input = ''; 
            document.getElementById(`p${pId}-input-display`).innerText = ''; 
        }

        function checkAnswer(pId) {
            if (!gameActive || players[pId].input === '') return;
            const val = parseInt(players[pId].input);
            clearInput(pId);
            if (val === players[pId].currentAns) {
                players[pId].score++; 
                showFeedback(pId, "–í–Ø–†–ù–û! ‚ú®", "#16a34a");
                updateProgress();
                if (players[pId].score >= WIN_SCORE) return endGame(players[pId].name);
                generateProblem(pId);
            } else {
                showFeedback(pId, `–ì–†–ï–®–ù–û! (${players[pId].currentAns})`, "#dc2626");
            }
        }

        function showFeedback(pId, txt, col) {
            const el = document.getElementById(`p${pId}-feedback`);
            el.innerText = txt; el.style.color = col; el.style.opacity = 1;
            el.style.transform = "translateY(-10px)";
            setTimeout(() => {
                el.style.opacity = 0;
                el.style.transform = "translateY(0)";
            }, 1000);
        }

        function updateProgress() {
            document.getElementById('progress-p1').style.width = (players[1].score/WIN_SCORE)*50 + '%';
            document.getElementById('progress-p2').style.width = (players[2].score/WIN_SCORE)*50 + '%';
        }

        function triggerAI() {
            if (!gameActive || !players[2].isAI) return;
            setTimeout(() => {
                if (!gameActive) return;
                players[2].input = players[2].currentAns.toString();
                checkAnswer(2);
                if (gameActive) triggerAI();
            }, 7000 + Math.random()*5000);
        }

        function endGame(w) {
            gameActive = false; document.getElementById('winner-name').innerText = w;
            switchScreen('screen-result'); startFireworks();
        }

        function resetGame() { switchScreen('screen-start'); }

        // --- PWA LOGIC ---
        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); });
        }
        
        let defPrompt;
        window.addEventListener('beforeinstallprompt', e => { 
            e.preventDefault(); 
            defPrompt = e; 
            document.getElementById('install-btn').classList.remove('hidden'); 
        });

        document.getElementById('install-btn').onclick = () => { 
            if(defPrompt) { 
                defPrompt.prompt(); 
                defPrompt.userChoice.then((res) => { if (res.outcome === 'accepted') document.getElementById('install-btn').classList.add('hidden'); defPrompt = null; });
            } 
        };

        const can = document.getElementById('fireworks-canvas');
        const ctx = can.getContext('2d');
        let pts = [];
        function startFireworks() { can.width = innerWidth; can.height = innerHeight; pts = []; ani(); }
        function ani() {
            if (!document.getElementById('screen-result').classList.contains('active')) return;
            ctx.clearRect(0,0,can.width,can.height);
            if (Math.random()<0.1) {
                const x=Math.random()*can.width, y=Math.random()*can.height, c=`hsl(${Math.random()*360},100%,50%)`;
                for(let i=0; i<12; i++) pts.push({x,y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,c,a:1});
            }
            pts.forEach((p,i) => {
                p.x+=p.vx; p.y+=p.vy; p.a-=0.02; ctx.globalAlpha=p.a; ctx.fillStyle=p.c;
                ctx.beginPath(); ctx.arc(p.x,p.y,2,0,7); ctx.fill();
                if(p.a<=0) pts.splice(i,1);
            });
            requestAnimationFrame(ani);
        }
    </script>
</body>
</html>
