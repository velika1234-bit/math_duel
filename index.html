<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –î—É–µ–ª ‚ú® Gemini</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap');
        
        body {
            font-family: 'Comfortaa', cursive;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #f0f9ff;
            user-select: none;
            touch-action: none;
            height: 100vh;
            width: 100vw;
        }

        .screen {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .active { display: flex; }

        .player-area {
            height: calc(50vh - 30px);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            padding: 10px;
            position: relative;
        }

        .player-1 { background-color: #dcfce7; transform: rotate(180deg); }
        .player-2 { background-color: #fee2e2; }

        .divider {
            height: 60px;
            width: 100%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .progress-container {
            width: 85%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        .progress-bar { height: 100%; transition: width 0.3s ease; }
        .progress-p1 { background: #22c55e; }
        .progress-p2 { background: #ef4444; }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            max-width: 240px;
        }

        .num-btn {
            width: 50px;
            height: 45px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #cbd5e1;
            cursor: pointer;
        }

        @media (max-height: 750px) {
            .avatar { width: 45px; height: 45px; }
            .num-btn { width: 45px; height: 38px; font-size: 1.1rem; }
            .question-box { font-size: 0.85rem !important; min-height: 50px !important; }
        }

        .num-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #cbd5e1; }
        .num-btn.confirm { background: #22c55e; color: white; box-shadow: 0 4px 0 #16a34a; }
        .num-btn.clear { background: #f97316; color: white; box-shadow: 0 4px 0 #ea580c; }

        .avatar { border-radius: 50%; border: 3px solid white; }

        .feedback {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s ease;
            text-align: center;
            z-index: 100;
        }

        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        .question-box {
            padding: 8px 12px;
            line-height: 1.2;
            max-width: 95%;
        }
    </style>
</head>
<body>

    <!-- –ï–∫—Ä–∞–Ω 1: –í—Ö–æ–¥ -->
    <div id="screen-start" class="screen active bg-gradient-to-b from-blue-400 to-blue-600 text-white p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –î—É–µ–ª ‚ú®</h1>
        <div class="bg-white p-6 rounded-3xl shadow-2xl text-gray-800 w-full max-w-sm">
            <div class="mb-4">
                <label class="block font-bold mb-1 text-sm text-blue-600">–ò–≥—Ä–∞—á 1 (üê∂)</label>
                <input type="text" id="p1-name" value="–ò–≥—Ä–∞—á 1" class="w-full border-2 border-blue-100 rounded-xl p-3 text-sm focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label class="block font-bold mb-1 text-sm text-red-600">–ò–≥—Ä–∞—á 2 (üê±)</label>
                <div class="flex gap-2">
                    <input type="text" id="p2-name" value="–ò–≥—Ä–∞—á 2" class="flex-1 border-2 border-red-100 rounded-xl p-3 text-sm focus:outline-none focus:border-red-500">
                    <button onclick="toggleAI()" id="ai-toggle" class="bg-purple-500 text-white px-4 rounded-xl font-bold text-xs hover:bg-purple-600 transition-colors">ü§ñ –†–æ–±–æ—Ç</button>
                </div>
            </div>
            <button onclick="goToSettings()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-4 rounded-2xl text-xl shadow-lg transform active:scale-95 transition-all">–ù–ê–ü–†–ï–î</button>
            <button id="install-btn" class="hidden mt-4 w-full border-2 border-purple-500 text-purple-600 font-bold py-2 rounded-xl text-xs uppercase hover:bg-purple-50 transition-colors">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</button>
        </div>
    </div>

    <!-- –ï–∫—Ä–∞–Ω 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="screen-settings" class="screen bg-blue-50 p-4">
        <h2 class="text-2xl font-bold mb-8 text-blue-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <div id="card-simple" class="bg-white p-5 rounded-3xl shadow-md border-4 border-blue-400 cursor-pointer text-center" onclick="selectDifficulty('simple')">
                <div class="text-4xl">üî¢</div>
                <h3 class="text-sm font-bold mt-2">–¢–∞–±–ª–∏—Ü–∞</h3>
            </div>
            <div id="card-hard" class="bg-white p-5 rounded-3xl shadow-md border-4 border-transparent cursor-pointer text-center" onclick="selectDifficulty('hard')">
                <div class="text-4xl">‚ú®</div>
                <h3 class="text-sm font-bold mt-2">–ò–ò –ó–∞–¥–∞—á–∏</h3>
            </div>
        </div>
        <div class="flex gap-6 mt-8">
            <button onclick="selectOp('*')" id="op-mult" class="op-btn bg-blue-400 text-white px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold transition-all text-xl">√ó</button>
            <button onclick="selectOp('/')" id="op-div" class="op-btn bg-white text-blue-600 px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold transition-all text-xl">√∑</button>
        </div>
        <button onclick="startGame()" class="mt-10 bg-green-500 text-white px-16 py-4 rounded-3xl text-xl font-bold shadow-lg hover:bg-green-600 transform active:scale-95 transition-all uppercase tracking-wide">–°–¢–ê–†–¢</button>
    </div>

    <!-- –ï–∫—Ä–∞–Ω 3: –ò–≥—Ä–∞ -->
    <div id="screen-game" class="screen">
        <!-- –ì–û–†–ù–û –ü–û–õ–ï (–ò–≥—Ä–∞—á 1) -->
        <div class="player-area player-1" id="p1-area">
            <div id="p1-feedback" class="feedback"></div>
            <div class="flex flex-col items-center w-full">
                <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Buddy&backgroundColor=b6e3f4" alt="Dog" class="avatar w-14 h-14 mb-1">
                <div class="bg-white px-4 py-3 rounded-2xl shadow-sm text-sm font-bold text-center w-[92%] min-h-[60px] flex items-center justify-center question-box" id="p1-question">...</div>
                <div class="text-2xl font-bold text-green-600 h-8" id="p1-input-display"></div>
            </div>
            <div class="numpad">
                <div class="num-btn" onclick="addNum(1, 1)">1</div><div class="num-btn" onclick="addNum(1, 2)">2</div><div class="num-btn" onclick="addNum(1, 3)">3</div>
                <div class="num-btn" onclick="addNum(1, 4)">4</div><div class="num-btn" onclick="addNum(1, 5)">5</div><div class="num-btn" onclick="addNum(1, 6)">6</div>
                <div class="num-btn" onclick="addNum(1, 7)">7</div><div class="num-btn" onclick="addNum(1, 8)">8</div><div class="num-btn" onclick="addNum(1, 9)">9</div>
                <div class="num-btn clear" onclick="clearInput(1)">C</div><div class="num-btn" onclick="addNum(1, 0)">0</div><div class="num-btn confirm" onclick="checkAnswer(1)">‚úî</div>
            </div>
        </div>

        <!-- –†–ê–ó–î–ï–õ–ò–¢–ï–õ –° –ü–†–û–ì–†–ï–° -->
        <div class="divider">
            <div class="progress-container">
                <div id="progress-p1" class="progress-bar progress-p1" style="width: 0%"></div>
                <div id="progress-p2" class="progress-bar progress-p2" style="width: 0%"></div>
            </div>
        </div>

        <!-- –î–û–õ–ù–û –ü–û–õ–ï (–ò–≥—Ä–∞—á 2) -->
        <div class="player-area player-2" id="p2-area">
            <div id="p2-feedback" class="feedback"></div>
            <div class="flex flex-col items-center w-full">
                <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Kitty&backgroundColor=ffd5dc" alt="Cat" class="avatar w-14 h-14 mb-1">
                <div class="bg-white px-4 py-3 rounded-2xl shadow-sm text-sm font-bold text-center w-[92%] min-h-[60px] flex items-center justify-center question-box" id="p2-question">...</div>
                <div class="text-2xl font-bold text-red-600 h-8" id="p2-input-display"></div>
            </div>
            <div class="numpad" id="p2-numpad">
                <div class="num-btn" onclick="addNum(2, 1)">1</div><div class="num-btn" onclick="addNum(2, 2)">2</div><div class="num-btn" onclick="addNum(2, 3)">3</div>
                <div class="num-btn" onclick="addNum(2, 4)">4</div><div class="num-btn" onclick="addNum(2, 5)">5</div><div class="num-btn" onclick="addNum(2, 6)">6</div>
                <div class="num-btn" onclick="addNum(2, 7)">7</div><div class="num-btn" onclick="addNum(2, 8)">8</div><div class="num-btn" onclick="addNum(2, 9)">9</div>
                <div class="num-btn clear" onclick="clearInput(2)">C</div><div class="num-btn" onclick="addNum(2, 0)">0</div><div class="num-btn confirm" onclick="checkAnswer(2)">‚úî</div>
            </div>
            <div id="p2-ai-msg" class="hidden text-red-500 font-bold italic animate-pulse text-[10px] mt-1">–ö–æ–º–ø—é—Ç—ä—Ä—ä—Ç –º–∏—Å–ª–∏...</div>
        </div>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –†–µ–∑—É–ª—Ç–∞—Ç -->
    <div id="screen-result" class="screen bg-purple-700 text-white p-6 relative">
        <canvas id="fireworks-canvas" class="absolute inset-0 pointer-events-none"></canvas>
        <div class="z-10 text-center">
            <h2 class="text-3xl font-bold mb-2">–ü–û–ë–ï–î–ò–¢–ï–õ!</h2>
            <div id="winner-name" class="text-5xl font-black text-yellow-300 mb-10 uppercase tracking-tighter">–ò–ú–ï</div>
            <div class="flex flex-col gap-4 items-center">
                <button onclick="resetGame()" class="bg-white text-purple-700 px-12 py-4 rounded-2xl text-xl font-bold shadow-xl hover:bg-gray-100 transition-colors">–ù–û–í–ê –ò–ì–†–ê</button>
                <button onclick="switchScreen('screen-settings')" class="text-white border-2 border-white/50 px-8 py-2 rounded-xl text-sm font-bold hover:bg-white/10">–°–ú–Ø–ù–ê –ù–ê –ù–ò–í–û</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 

        let players = {
            1: { name: '–ò–≥—Ä–∞—á 1', score: 0, input: '', currentAns: 0, questionText: '' },
            2: { name: '–ò–≥—Ä–∞—á 2', score: 0, input: '', currentAns: 0, questionText: '', isAI: false }
        };
        let gameSettings = { difficulty: 'simple', op: '*' };
        const WIN_SCORE = 10;
        let gameActive = false;

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            } catch (error) {
                if (retries === 0) throw error;
                await new Promise(resolve => setTimeout(resolve, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        }

        async function callGemini(prompt, sys = "–¢–∏ —Å–∏ –∑–∞–±–∞–≤–µ–Ω —É—á–∏—Ç–µ–ª –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞. –û—Ç–≥–æ–≤–∞—Ä—è–π –≤–∏–Ω–∞–≥–∏ —Å JSON.") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: sys }] },
                generationConfig: { responseMimeType: "application/json" }
            };
            try {
                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return content ? JSON.parse(content) : null;
            } catch (e) {
                return null;
            }
        }

        // –õ–æ–≥–∏–∫–∞
        function goToSettings() {
            players[1].name = document.getElementById('p1-name').value || '–ò–≥—Ä–∞—á 1';
            players[2].name = document.getElementById('p2-name').value || '–ò–≥—Ä–∞—á 2';
            switchScreen('screen-settings');
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toggleAI() {
            players[2].isAI = !players[2].isAI;
            const btn = document.getElementById('ai-toggle');
            btn.innerText = players[2].isAI ? "ü§ñ –†–æ–±–æ—Ç" : "üë¶ –ß–æ–≤–µ–∫";
            document.getElementById('p2-name').value = players[2].isAI ? "–†–æ–±–æ—Ç –ú–∞–∫—Å" : "–ò–≥—Ä–∞—á 2";
        }

        function selectDifficulty(d) {
            gameSettings.difficulty = d;
            document.getElementById('card-simple').style.borderColor = (d === 'simple') ? '#3b82f6' : 'transparent';
            document.getElementById('card-hard').style.borderColor = (d === 'hard') ? '#a855f7' : 'transparent';
        }

        function selectOp(op) {
            gameSettings.op = op;
            const multBtn = document.getElementById('op-mult');
            const divBtn = document.getElementById('op-div');
            if (op === '*') {
                multBtn.className = 'op-btn bg-blue-400 text-white px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
                divBtn.className = 'op-btn bg-white text-blue-600 px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
            } else {
                multBtn.className = 'op-btn bg-white text-blue-600 px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
                divBtn.className = 'op-btn bg-blue-400 text-white px-10 py-3 rounded-2xl border-2 border-blue-400 font-bold text-xl';
            }
        }

        function startGame() {
            players[1].score = 0; players[2].score = 0;
            updateProgress();
            if (players[2].isAI) {
                document.getElementById('p2-numpad').classList.add('hidden');
                document.getElementById('p2-ai-msg').classList.remove('hidden');
            } else {
                document.getElementById('p2-numpad').classList.remove('hidden');
                document.getElementById('p2-ai-msg').classList.add('hidden');
            }
            generateProblem(1); generateProblem(2);
            switchScreen('screen-game');
            gameActive = true;
            if (players[2].isAI) triggerAI();
        }

        async function generateProblem(pId) {
            const qEl = document.getElementById(`p${pId}-question`);
            qEl.innerHTML = '<span class="loading-dots">–ì–µ–Ω–µ—Ä–∏—Ä–∞–º</span>';
            
            players[pId].input = '';
            document.getElementById(`p${pId}-input-display`).innerText = '';

            let q, ans;
            if (gameSettings.difficulty === 'simple') {
                let a = Math.floor(Math.random()*8)+2;
                let b = Math.floor(Math.random()*8)+2;
                if (gameSettings.op === '*') {
                    q = `${a} √ó ${b} = ?`; ans = a*b;
                } else {
                    let product = a * b;
                    q = `${product} √∑ ${a} = ?`; ans = b;
                }
            } else {
                const opType = gameSettings.op === '*' ? '—É–º–Ω–æ–∂–µ–Ω–∏–µ' : '–¥–µ–ª–µ–Ω–∏–µ';
                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞ –ø–æ-–∫—Ä–∞—Ç–∫–∞ –∑–∞–¥–∞—á–∞
                const prompt = `–ù–∞–ø–∏—à–∏ 1 –ú–ù–û–ì–û –ö–†–ê–¢–ö–ê —Ç–µ–∫—Å—Ç–æ–≤–∞ –∑–∞–¥–∞—á–∞ (–º–∞–∫—Å–∏–º—É–º 10 –¥—É–º–∏) –∑–∞ ${opType} –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏. –ò–∑–ø–æ–ª–∑–≤–∞–π –º–∞–ª–∫–∏ —á–∏—Å–ª–∞. –§–æ—Ä–º–∞—Ç: {"question": "...", "answer": —á–∏—Å–ª–æ}`;
                const res = await callGemini(prompt);
                if (res) { q = res.question; ans = res.answer; } else { q = "–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞!"; ans = 0; }
            }
            players[pId].currentAns = ans;
            qEl.innerText = q;
        }

        function addNum(pId, n) { if (gameActive) { players[pId].input += n; document.getElementById(`p${pId}-input-display`).innerText = players[pId].input; } }
        function clearInput(pId) { players[pId].input = ''; document.getElementById(`p${pId}-input-display`).innerText = ''; }

        function checkAnswer(pId) {
            if (!gameActive || players[pId].input === '') return;
            const val = parseInt(players[pId].input);
            clearInput(pId);

            if (val === players[pId].currentAns) {
                players[pId].score++; 
                showFeedback(pId, "–í–Ø–†–ù–û! ‚ú®", "#16a34a");
                updateProgress();
                if (players[pId].score >= WIN_SCORE) return endGame(players[pId].name);
                generateProblem(pId);
            } else {
                showFeedback(pId, `–ì–†–ï–®–ù–û! (${players[pId].currentAns})`, "#dc2626");
            }
        }

        function showFeedback(pId, txt, col) {
            const el = document.getElementById(`p${pId}-feedback`);
            el.innerText = txt; el.style.color = col; el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1500);
        }

        function updateProgress() {
            document.getElementById('progress-p1').style.width = (players[1].score/WIN_SCORE)*50 + '%';
            document.getElementById('progress-p2').style.width = (players[2].score/WIN_SCORE)*50 + '%';
        }

        function triggerAI() {
            if (!gameActive || !players[2].isAI) return;
            setTimeout(() => {
                if (!gameActive) return;
                players[2].input = players[2].currentAns.toString();
                checkAnswer(2);
                if (gameActive) triggerAI();
            }, 6000 + Math.random()*5000);
        }

        function endGame(w) {
            gameActive = false; document.getElementById('winner-name').innerText = w;
            switchScreen('screen-result'); startFireworks();
        }

        function resetGame() { switchScreen('screen-start'); }

        // PWA
        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); });
        }
        
        let defPrompt;
        window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); defPrompt = e; document.getElementById('install-btn').classList.remove('hidden'); });
        document.getElementById('install-btn').onclick = () => { if(defPrompt) { defPrompt.prompt(); defPrompt = null; } };

        // Fireworks
        const can = document.getElementById('fireworks-canvas');
        const ctx = can.getContext('2d');
        let pts = [];
        function startFireworks() { can.width = innerWidth; can.height = innerHeight; pts = []; ani(); }
        function ani() {
            if (!document.getElementById('screen-result').classList.contains('active')) return;
            ctx.clearRect(0,0,can.width,can.height);
            if (Math.random()<0.1) {
                const x=Math.random()*can.width, y=Math.random()*can.height, c=`hsl(${Math.random()*360},100%,50%)`;
                for(let i=0; i<12; i++) pts.push({x,y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,c,a:1});
            }
            pts.forEach((p,i) => {
                p.x+=p.vx; p.y+=p.vy; p.a-=0.02; ctx.globalAlpha=p.a; ctx.fillStyle=p.c;
                ctx.beginPath(); ctx.arc(p.x,p.y,2,0,7); ctx.fill();
                if(p.a<=0) pts.splice(i,1);
            });
            requestAnimationFrame(ani);
        }
    </script>
</body>
</html>
